/**************************************************************************************************
* include
**************************************************************************************************/
#include <string.h>
#include "ql_wlan.h"
#include "ql_ori.h"
#include "ql_api_osi.h"
#include <esp_err.h>
#include "cJSON.h"
/**************************************************************************************************
* define
**************************************************************************************************/
#define ql_setting_ssid_html_gz_len 1066
/**************************************************************************************************
* Parameter
**************************************************************************************************/
const unsigned char ql_setting_ssid_html_gz[] = {
    0x1f, 0x8b, 0x08, 0x08, 0xca, 0x81, 0x80, 0x63, 0x00, 0x03, 0x73, 0x65, 0x74, 0x74, 0x69, 0x6e,
    0x67, 0x5f, 0x73, 0x73, 0x69, 0x64, 0x2e, 0x68, 0x74, 0x6d, 0x6c, 0x00, 0xcd, 0x57, 0x6d, 0x6f,
    0xdb, 0x36, 0x10, 0xfe, 0xee, 0x5f, 0x71, 0x25, 0x30, 0xc4, 0x49, 0x53, 0xcb, 0x4b, 0xb3, 0x60,
    0xa8, 0x6d, 0x01, 0x4b, 0xe7, 0xae, 0x1e, 0x92, 0x26, 0xa8, 0x0d, 0xa4, 0xd8, 0x32, 0x18, 0xb4,
    0x74, 0x8e, 0xd9, 0xd2, 0x94, 0x46, 0x52, 0xb1, 0xdd, 0x36, 0xff, 0x7d, 0x47, 0xd1, 0xb2, 0x15,
    0x5b, 0x5e, 0x9d, 0x62, 0x1f, 0xa6, 0x2f, 0x12, 0xef, 0xf5, 0xe1, 0xdd, 0xc3, 0x17, 0xb5, 0x27,
    0x76, 0x2a, 0xc3, 0x5a, 0x7b, 0x82, 0x3c, 0x0e, 0xa1, 0xd6, 0x9e, 0xa2, 0xe5, 0x10, 0x4d, 0xb8,
    0x36, 0x68, 0x3b, 0x2c, 0xb3, 0xe3, 0x17, 0x3f, 0x33, 0x27, 0xb7, 0xc2, 0x4a, 0x0c, 0xfb, 0xdd,
    0xc1, 0xa0, 0xf7, 0xee, 0xb7, 0x76, 0xe0, 0x87, 0x24, 0x0f, 0x72, 0xc7, 0x5a, 0x7b, 0x94, 0xc4,
    0x0b, 0x7a, 0x59, 0x3e, 0x92, 0x08, 0x91, 0xe4, 0xc6, 0x74, 0xd8, 0x58, 0xcc, 0x31, 0x66, 0x30,
    0x4a, 0x74, 0x8c, 0xba, 0xc3, 0x9a, 0x2c, 0xac, 0x01, 0x3d, 0xed, 0x28, 0x91, 0x30, 0x13, 0xb1,
    0x9d, 0x74, 0xd8, 0x8f, 0xcd, 0x66, 0x33, 0x9d, 0x33, 0x08, 0xc2, 0xb2, 0xf4, 0xa7, 0x42, 0xe8,
    0xed, 0xad, 0x0e, 0xdb, 0x36, 0xf6, 0x83, 0x5c, 0x30, 0x39, 0x09, 0xdf, 0xbc, 0xbe, 0x7c, 0x79,
    0xd6, 0xbc, 0x81, 0x7e, 0xbf, 0xf7, 0x2b, 0xf4, 0xd1, 0x5a, 0xa1, 0xee, 0xe0, 0x06, 0x47, 0x04,
    0xe8, 0x64, 0xe9, 0x16, 0x14, 0x3e, 0xf4, 0xa5, 0x77, 0x85, 0xf2, 0x80, 0x37, 0x21, 0xae, 0xd5,
    0xfa, 0xb1, 0xc0, 0x0b, 0xe3, 0x6d, 0x61, 0xae, 0x90, 0x7c, 0x84, 0x12, 0xc6, 0x09, 0x45, 0xa2,
    0xf2, 0x19, 0x23, 0x62, 0x16, 0x12, 0x36, 0xe0, 0x39, 0xcc, 0x76, 0x90, 0xeb, 0x2b, 0x02, 0x06,
    0x55, 0x11, 0x29, 0x0d, 0x50, 0x4d, 0x4c, 0xca, 0x55, 0x87, 0x9d, 0xb0, 0x1d, 0x29, 0x85, 0x4a,
    0x33, 0x0b, 0x22, 0x5e, 0x67, 0x04, 0xbb, 0x48, 0xb1, 0xc3, 0x2c, 0xce, 0x2d, 0x03, 0x63, 0x17,
    0x92, 0x06, 0x79, 0x5d, 0x5f, 0x51, 0xb1, 0x7f, 0x68, 0x55, 0x04, 0xda, 0xce, 0xbf, 0xae, 0xd8,
    0x7f, 0x52, 0x89, 0x74, 0xb6, 0x2a, 0xc4, 0x35, 0x31, 0x63, 0x46, 0xd5, 0x7e, 0x7a, 0x31, 0xf6,
    0x29, 0x80, 0x4b, 0xf4, 0xbf, 0x98, 0xff, 0x28, 0xb3, 0x36, 0x51, 0x1e, 0x56, 0x36, 0x9a, 0x0a,
    0x5b, 0xc0, 0xf2, 0x0a, 0x06, 0x89, 0x8a, 0xa4, 0x88, 0x3e, 0x15, 0xea, 0xfa, 0x21, 0x0b, 0xfd,
    0x57, 0x3b, 0xf0, 0x26, 0x4f, 0x87, 0x49, 0x23, 0x47, 0xe6, 0x12, 0xfb, 0xbd, 0x7e, 0x25, 0x6f,
    0x9b, 0x48, 0x8b, 0xd4, 0x86, 0xb5, 0x71, 0xa6, 0x22, 0x2b, 0x08, 0x5f, 0x91, 0x1c, 0xbe, 0xd4,
    0x82, 0x23, 0x1f, 0xe5, 0x9e, 0x6b, 0x70, 0x3c, 0x1a, 0xde, 0x73, 0x99, 0x21, 0x74, 0x80, 0xdd,
    0x32, 0xc7, 0xde, 0x5b, 0xf6, 0xea, 0x96, 0x31, 0x78, 0x0e, 0x71, 0x12, 0x65, 0x53, 0x54, 0xb6,
    0x71, 0x87, 0xb6, 0x2b, 0xd1, 0x7d, 0x9e, 0x2f, 0x7a, 0x71, 0x7d, 0x45, 0xc0, 0xc3, 0x86, 0x77,
    0x7d, 0xee, 0x5c, 0x59, 0xab, 0xb6, 0x0a, 0x4b, 0xdd, 0x29, 0x47, 0xbd, 0xbe, 0xd9, 0x2f, 0xa8,
    0x6b, 0xea, 0xce, 0x98, 0x7e, 0x06, 0xc3, 0x94, 0xdb, 0x89, 0x8b, 0xfa, 0xc5, 0x05, 0x2b, 0xc1,
    0x27, 0xfb, 0x63, 0x27, 0x5a, 0xa7, 0x26, 0xc9, 0x03, 0x6b, 0xc1, 0x51, 0x50, 0xab, 0x9e, 0xee,
    0xbe, 0xd3, 0xdb, 0x31, 0xaf, 0x3d, 0x27, 0xb2, 0x73, 0x06, 0x0a, 0x67, 0x70, 0x35, 0xfa, 0x88,
    0x11, 0x75, 0x65, 0x69, 0x54, 0x32, 0x68, 0x38, 0x04, 0x64, 0xb5, 0x46, 0x5c, 0x61, 0x43, 0x69,
    0xc8, 0x64, 0x05, 0xaa, 0x94, 0xea, 0xa3, 0xa1, 0x9e, 0x77, 0xe0, 0xf7, 0xfe, 0xd5, 0xbb, 0x86,
    0xb1, 0x9a, 0xb6, 0x4c, 0x31, 0x5e, 0xd4, 0x4b, 0xbe, 0x94, 0x72, 0xc9, 0x03, 0x67, 0x1e, 0x4d,
    0xbe, 0xb3, 0x2a, 0x4f, 0x70, 0x2e, 0xd7, 0xa4, 0x68, 0x0a, 0x41, 0xb8, 0xe4, 0x73, 0x30, 0xe2,
    0x33, 0x42, 0x32, 0x06, 0x4e, 0xeb, 0x48, 0xc5, 0xe2, 0x5e, 0xc4, 0x19, 0xa7, 0x3d, 0x45, 0x48,
    0x6c, 0x90, 0xfe, 0x13, 0xd2, 0xa4, 0x35, 0x82, 0x9d, 0x08, 0xe3, 0x67, 0x78, 0x04, 0x3e, 0xa1,
    0x30, 0x60, 0xf8, 0x14, 0x81, 0x1b, 0x52, 0x72, 0x0b, 0x94, 0x85, 0x02, 0xe4, 0x8e, 0x43, 0x83,
    0xfa, 0x1e, 0x75, 0x23, 0x2a, 0x52, 0x39, 0xa4, 0x97, 0xbf, 0x7c, 0x18, 0xbe, 0xe9, 0x5d, 0x74,
    0x87, 0xfd, 0xde, 0x1f, 0x5d, 0x82, 0x7b, 0x76, 0xda, 0xaa, 0xd6, 0x0d, 0xfb, 0x83, 0xf7, 0x8e,
    0x64, 0x67, 0xa7, 0xe7, 0x44, 0xc1, 0xdc, 0x46, 0x8c, 0xa1, 0xbe, 0x6e, 0x46, 0x43, 0xa2, 0xba,
    0x73, 0x6d, 0xec, 0x40, 0x13, 0xdc, 0xa2, 0x2a, 0x96, 0x26, 0x97, 0xa8, 0x6d, 0x9d, 0x5d, 0x4b,
    0xe4, 0x06, 0x73, 0x40, 0x6e, 0x49, 0x3d, 0x63, 0xcb, 0x16, 0x3f, 0x00, 0x4a, 0x92, 0xbb, 0x60,
    0xab, 0xb6, 0x95, 0x63, 0x55, 0x85, 0x5a, 0xee, 0xa3, 0x10, 0x71, 0xa5, 0x12, 0x0b, 0x23, 0x04,
    0x9c, 0xa6, 0x76, 0x51, 0x15, 0x73, 0x1b, 0x60, 0x48, 0x93, 0x84, 0xaf, 0x5f, 0x61, 0x2b, 0x9b,
    0x53, 0x54, 0x64, 0xbb, 0xf0, 0x5a, 0x6a, 0x46, 0x7e, 0xde, 0x52, 0xca, 0x78, 0x05, 0x60, 0x9a,
    0x99, 0x3c, 0xbd, 0x44, 0x93, 0x17, 0x5c, 0x51, 0x88, 0xf3, 0x4d, 0x18, 0xeb, 0x88, 0x7b, 0x30,
    0x29, 0x16, 0xc6, 0x6d, 0x58, 0x8e, 0xc5, 0x56, 0xaf, 0x08, 0xfc, 0x0d, 0x5f, 0x4f, 0xa4, 0xef,
    0x70, 0xf5, 0xdb, 0x73, 0x85, 0xeb, 0xca, 0x37, 0x38, 0xca, 0xb9, 0xe0, 0x08, 0x44, 0x4a, 0xf7,
    0xea, 0xb9, 0x43, 0xe7, 0xcf, 0xe6, 0x5f, 0xeb, 0x7d, 0x64, 0xc9, 0x97, 0xf9, 0xc4, 0xda, 0x74,
    0xb9, 0x8c, 0x3f, 0x5c, 0x5e, 0xbc, 0xa5, 0xd1, 0x7b, 0xfc, 0x3b, 0x43, 0xb3, 0x5e, 0xce, 0xf4,
    0xe4, 0x56, 0x8d, 0x44, 0x69, 0xba, 0x3b, 0x2d, 0x8c, 0xe5, 0x16, 0xe9, 0xc6, 0xa5, 0xee, 0xf2,
    0xe8, 0xcb, 0xad, 0xb9, 0x5e, 0xee, 0x42, 0xc1, 0x34, 0xef, 0x97, 0x7b, 0xf5, 0x9d, 0x97, 0x23,
    0xc7, 0xe9, 0xa6, 0xe1, 0x63, 0x63, 0x17, 0x3d, 0x33, 0xce, 0xf0, 0xa4, 0xd9, 0xac, 0x32, 0x7d,
    0x54, 0x9c, 0x24, 0x45, 0x55, 0x06, 0x5a, 0x69, 0x34, 0xd3, 0xc2, 0xe2, 0x0a, 0x8b, 0x49, 0x13,
    0x65, 0x70, 0x40, 0xa7, 0xed, 0xb7, 0xfc, 0x22, 0x99, 0x18, 0xac, 0x8a, 0x5e, 0xa2, 0xea, 0x26,
    0xe8, 0x9d, 0x90, 0x97, 0xc4, 0xec, 0xe7, 0xeb, 0x19, 0xf2, 0xd0, 0x31, 0xb1, 0x8f, 0xee, 0x9e,
    0x89, 0x52, 0xe8, 0x4f, 0x37, 0x3e, 0xd2, 0x59, 0x6a, 0xe5, 0x7a, 0x4d, 0x6c, 0x3e, 0x32, 0x89,
    0xb8, 0xb3, 0xa4, 0x69, 0xc8, 0x84, 0xc7, 0xf5, 0xc3, 0x5d, 0xd0, 0xfe, 0x0d, 0xc3, 0x23, 0xc8,
    0x74, 0xba, 0x40, 0x57, 0xeb, 0x44, 0x3f, 0xbb, 0x55, 0xee, 0xdc, 0xd9, 0xbb, 0x4a, 0x7b, 0x40,
    0xa9, 0x55, 0x8f, 0x1e, 0xb6, 0x78, 0xe5, 0x9a, 0xc8, 0xae, 0xaf, 0xfa, 0x03, 0x76, 0x0c, 0x2c,
    0x30, 0xfe, 0x72, 0x4c, 0xdf, 0x8e, 0xd6, 0x5b, 0x2c, 0x24, 0xf5, 0x92, 0xa1, 0x6f, 0x89, 0x57,
    0xa8, 0xeb, 0x07, 0xaf, 0x13, 0x65, 0xa9, 0x5f, 0x2f, 0x06, 0x74, 0x61, 0x39, 0x38, 0x3e, 0x70,
    0x17, 0xa9, 0xc0, 0xfd, 0x25, 0x1c, 0x54, 0xf8, 0xaa, 0xb8, 0xee, 0x0e, 0x95, 0xc3, 0x16, 0xf8,
    0xd5, 0x5e, 0x7b, 0xa0, 0xeb, 0x46, 0x71, 0xcd, 0xa0, 0xab, 0x8c, 0xff, 0x2b, 0x08, 0xfc, 0x4f,
    0xc6, 0x3f, 0x87, 0x92, 0xd8, 0xfc, 0x6c, 0x0c, 0x00, 0x00};

static ql_task_t wlan_cfgnet_thread_handle = NULL;
uint8_t ql_sta_start_flag = 0;
/**************************************************************************************************
* Function wlan config network test
**************************************************************************************************/
/**************************************************************************************************
* Function    : ql_ap_network_ap_start
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description :
**************************************************************************************************/
static void ql_ap_network_ap_start(void)
{
    os_printf(LM_WIFI, LL_INFO, "ap start.\r\n");
    
    ql_network_init_s wificonfig;
    
    memset(&wificonfig, 0, sizeof(ql_network_init_s));
    wificonfig.wifi_mode = QL_SOFT_AP;
    memcpy(&wificonfig.wifi_ssid, "FCM360W_WEB", sizeof("FCM360W_WEB"));
    memcpy(&wificonfig.wifi_key, "12345678", sizeof("12345678"));
    wificonfig.authmode = AUTH_WPA_WPA2_PSK;
    // wificonfig.ap.max_connect = 2;
    // wificonfig.ap.hidden_ssid = 0;
    ql_wlan_start(&wificonfig);
}

/**************************************************************************************************
* Function    : ql_ap_network_sta_connect
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description :
**************************************************************************************************/
static void ql_ap_network_sta_connect(char *ssid, char *password)
{
    os_printf(LM_CMD, LL_INFO, "wifi connect.\r\n");
    os_printf(LM_CMD, LL_INFO, "ssid:%s, password:%s  \r\n", ssid, password);
    
    ql_network_init_s wificonfig = {0};
    
    memset(&wificonfig, 0, sizeof(wificonfig));
    wificonfig.wifi_mode = QL_STATION;
    memcpy(&wificonfig.wifi_ssid, ssid,     strlen((char*)ssid));
    memcpy(&wificonfig.wifi_key,  password, strlen((char*)password));
    wificonfig.dhcp_mode = 1;
    ql_wlan_start(&wificonfig);
}

/**************************************************************************************************
* Function    : ql_setting_handler
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description :
**************************************************************************************************/
static esp_err_t ql_setting_handler(httpd_req_t *req)
{
    httpd_resp_set_type(req, "text/html");
    httpd_resp_set_hdr(req, "Content-Encoding", "gzip");
    return httpd_resp_send(req, (const char *)ql_setting_ssid_html_gz, ql_setting_ssid_html_gz_len);
}
/**************************************************************************************************
* Function    : ql_setting_handler
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description : An HTTP POST handler
**************************************************************************************************/
static esp_err_t setting_post_handler(httpd_req_t *req)
{
    char buf[100];
    int ret, remaining = req->content_len;

    while (remaining > 0)
    {
        /* Read the data for the request */
        if ((ret = httpd_req_recv(req, buf,MIN(remaining, sizeof(buf)))) <= 0)
        {
            if (ret == HTTPD_SOCK_ERR_TIMEOUT)
            {
                /* Retry receiving if timeout occurred */
                continue;
            }
            return ESP_FAIL;
        }
        /* Send back the same data */
        char *notice = "Setting Succeed!";
        httpd_resp_send_chunk(req, notice, strlen(notice) + 1);
        remaining -= ret;
        /* my json code begin */
        const char *json = buf;
        cJSON *root_base = cJSON_Parse(json); // change to json object
        if (root_base)
        {

            cJSON *cParse1 = cJSON_GetObjectItem(root_base, "ssid");
            cJSON *cParse2 = cJSON_GetObjectItem(root_base, "pwd");
            os_printf(LM_APP, LL_INFO, "\nssid = %s\npassword = %s\n", cParse1->valuestring, cParse2->valuestring);
            ql_wlan_stop(QL_SOFT_AP);
            ql_ap_network_sta_connect(cParse1->valuestring, cParse2->valuestring);
            cJSON_Delete(root_base);
        }
    }

    // End response
    httpd_resp_send_chunk(req, NULL, 0);
    return ESP_OK;
}

httpd_uri_t ql_setting_get = {
    .uri = "/setting",
    .method = HTTP_GET,
    .handler = ql_setting_handler,
    .user_ctx = NULL};
    
static const httpd_uri_t ql_setting_post = {
    .uri = "/setting",
    .method = HTTP_POST,
    .handler = setting_post_handler,
    .user_ctx = NULL};

/**************************************************************************************************
* Function    : ql_start_webserver
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description : 
**************************************************************************************************/
httpd_handle_t ql_start_webserver(void)
{
    httpd_handle_t server = NULL;
    httpd_config_t config = HTTPD_DEFAULT_CONFIG();
    config.lru_purge_enable = true;

    // Start the httpd server
    os_printf(LM_APP, LL_INFO, "Starting server on port: '%d' \r\n", config.server_port);
    
    if (httpd_start(&server, &config) == 0)
    {
        // Set URI handlers
        os_printf(LM_APP, LL_INFO, "Registering URI handlers \r\n");
        httpd_register_uri_handler(server, &ql_setting_get);
        httpd_register_uri_handler(server, &ql_setting_post);
        return server;
    }

    os_printf(LM_APP, LL_INFO, "Error starting server!");
    return NULL;
}

/**************************************************************************************************
* Function    : ql_ap_network_demo
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description :
**************************************************************************************************/
void ql_ap_network_demo(void *param)
{
    ql_rtos_task_sleep_ms(3000);
    
    ql_ap_network_ap_start();
    
    while (1)
    {   
        if(ql_wlan_get_ap_status() == QL_AP_STATUS_STARTED)
        {            
            os_printf(LM_APP, LL_INFO, "ql_wlan_get_ap_status:%d \r\n", ql_wlan_get_ap_status());
            
            httpd_handle_t server = ql_start_webserver();
            
            if (server)
            {
                os_printf(LM_APP, LL_INFO, "ql_start_webserver!\r\n");
            }

            break;
        }
        
        ql_rtos_task_sleep_ms(1000);
    }

    while(1)
    {
        ql_rtos_task_sleep_ms(1000);
    }
}

/**************************************************************************************************
* Function    : ql_wlan_cfgnet_demo_thread_creat
*
* Author      : 
*
* Parameters  :
*
* Return      :
*
* Description :
**************************************************************************************************/
void ql_wlan_cfgnet_demo_thread_creat(void)
{
    int ret;
    
    ret = ql_rtos_task_create(&wlan_cfgnet_thread_handle,
                              (unsigned short)8*1024,
                              RTOS_HIGHER_PRIORTIY_THAN(3),
                              "wlan_cfgnet_test",
                              ql_ap_network_demo,
                              0);

    if (ret != QL_OSI_SUCCESS)
    {
        os_printf(LM_WIFI, LL_INFO, "Error: Failed to create wlan config net test thread: %d\r\n", ret);
        goto init_err;
    }

    return;

init_err:
    if (wlan_cfgnet_thread_handle != NULL)
    {
        ql_rtos_task_delete(wlan_cfgnet_thread_handle);
    }
}
